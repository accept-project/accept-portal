@model AcceptPortal.Models.Admin.Project
@using AcceptPortal.Utils;

@{
    ViewBag.Title = AcceptPortal.Resources.Global.PostEditProjectDetail;
}
    <link href="@Url.Content("~/Content/PreEdit/v2.0/Accept.css")" rel="stylesheet" type="text/css" />  
    @*<link href="@Url.Content("~/Content/PostEdit/v1.0/jquery-ui-1.8.17.customPost.css")" rel="stylesheet" type="text/css" />*@    
    <link href="@Url.Content("~/Content/PostEdit/v1.0/PostEdit.css")" rel="stylesheet" type="text/css" />        

    <style type="text/css">

        #postEditDialog_
        {
            line-height: normal;
        }
        #postEditDialog_.container 
        {
            display: table;
            font-family: "Trebuchet MS",Verdana,Helvetica,Sans-Serif;
            width:auto;
        }

    </style>

    <!--main menu section-->
    @if (Model.Status != -1)
    { 
        <h2>@AcceptPortal.Resources.Global.PostEditProjectNameLabel @Model.ProjectName</h2>
        <h4>@AcceptPortal.Resources.Global.PostEditProjectCreatedByLabel @Model.ProjectOwner</h4>
        
        if (Model.ProjectOwner.CompareTo(User.Identity.Name) == 0 || Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") == 0)
        {
            if (Model.ProjectSurvey.Length > 0)
            {
                string url = Model.ProjectSurvey.Trim();
                if (!url.StartsWith("http"))
                {
                    url = "http://" + url;
                }                            
                  <h4>@AcceptPortal.Resources.Global.PostEditProjectSurveyLink : <a style="padding:5px;color:#faa732;" href="@url" target="_blank">@Model.ProjectSurvey</a></h4>                                   
            }
        }
    }

    <div> 
    
    <!--main menu section-->
    <ul class="horizontal-slide">
    @if (Model.ProjectOwner.CompareTo(User.Identity.Name) == 0 || Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") == 0)
    {
        string projectReportUrl = CoreUtils.AcceptPortalApiPath + "/PostEdit/ProjectXliff?token=" + Model.AdminToken;  
       
            <li><a class="underline-over" href="@projectReportUrl">@AcceptPortal.Resources.Global.PostEditAllProjectRevisionsLabel </a></li>
            if (!Model.External)
            {          
                <li><a class="underline-over" href="#" id="inviteUsersAnchor">@AcceptPortal.Resources.Global.PostEditInviteUseresLabel </a></li>
            }
            else{
            <li><a class="underline-over" href="#" id="btnDialogManageProject">@AcceptPortal.Resources.Global.PosEditProjectDetail_LabelManageProject</a></li>                     
            
            }
            <li><a class="underline-over" href="#" id="checkTaskStatus">@AcceptPortal.Resources.Global.CheckProjectTasksStatusLabel </a></li>
            <li><a class="underline-over" href="#" id="myProjectDetails">@AcceptPortal.Resources.Global.MyProjectDetailsLabel </a></li>
            <li><a class="underline-over" href="#" id="btnOpenUploadDialog">@AcceptPortal.Resources.Global.PostEditUploadProjectTask </a></li>                    
            
            <li><a class="underline-over" href="@Url.Action("Index", "PostEdit")">@AcceptPortal.Resources.Global.PosEditBackToProjectList </a></li>        
    }
    else
    {
        <li><a class="underline-over" href="@Url.Action("Index", "PostEdit")">@AcceptPortal.Resources.Global.PosEditBackToProjectList </a></li>
    }  
    </ul>
    </div>
    
    <!--main menu section-->
    
    <!--upload file section-->

       @if (Model.ProjectOwner.CompareTo(User.Identity.Name) == 0 || Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") == 0)
       {   
        <div id="divUploadFileDialog" style="display:none;">
       
        <div id="uploadFile" style="display:block;">

        @*<h3>@AcceptPortal.Resources.Global.PostEditUploadProjectTask</h3> *@

        @using (Html.BeginForm("UploadFile", "PostEdit", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {    
            <label for="file">@AcceptPortal.Resources.Global.PostEditFileNameLabel</label>
            <input  type="file" name="file" id="file"    />
            <input class="button-link" style="height:25px;width:100px;" type="submit" value="@AcceptPortal.Resources.Global.PostEditUploadTaskLabel" />    
            <input type="hidden" name="projectId" id="projectId" value="@Model.ID" />
        }
        </div>
        </div>
       }

    <!--upload file section-->
 
@{      
    var count = 0;          
}

@if (Model.Documents.Any())
{
       <!--tasks section-->
    <div style="margin-top:20px;">
    <table border=1 id="tblPostEditTasks">
        <thead>
        <tr>
        <th><b>@AcceptPortal.Resources.Global.PostEditTaskLabel</b></th>       
        <th><b>@AcceptPortal.Resources.Global.EvaluationActions</b></th>          
        </tr>
    </thead>
        <tbody>
       @foreach (var doc in Model.Documents)
       {
           string userName = Model.SingleRevision ? Model.ProjectOwner.ToString() : User.Identity.Name.ToString();
           string documentReportUrl = CoreUtils.AcceptPortalApiPath + "/PostEdit/DocumentXliff?userId=" + userName + "&textId=" + doc.TextId;
           string allTasksReportUrl = CoreUtils.AcceptPortalApiPath + "/PostEdit/TaskXliff?token=" + Model.AdminToken.ToString() + "&textId=" + doc.TextId;                       
        
        <tr>
        <td class="leftT" title="@doc.TextId">      
            <span> @AcceptPortal.Resources.Global.PostEditTaskLabel @{ count++; } @count </span>
        </td>
           
        @if (Model.ProjectOwner.CompareTo(User.Identity.Name) == 0)
        {
            <td>                 
            <a  title="@doc.TextId"  class="EditTask" href="#">@AcceptPortal.Resources.Global.PostEditTaskEditLabel  <div class="userContainer" style="display:none" title="@User.Identity.Name.ToString()"></div> </a>                                      
            |
                <a  href="@documentReportUrl" target="_blank">@AcceptPortal.Resources.Global.PostEditCheckRevisionLabel</a> 
            |
                <a  href="@allTasksReportUrl" target="_blank">@AcceptPortal.Resources.Global.AllTaskRevisionsLabel</a>            
            
                <a name="deleteTaskAnchor_&@doc.ID" href="@Url.Action("DeleteDocument", "PostEdit", new { @textId = doc.TextId, @projectOwner = User.Identity.Name, @projectId = doc.ProjectId })" target="_blank"></a> 
            |
                <b style="cursor:pointer;" id="deleteTask_&@doc.ID" style="color:#0E9E4C;cursor:pointer">@AcceptPortal.Resources.Global.PostEditDeleteTaskLabel</b>
          </td>
        }
        else
            if (Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") == 0)
            {        
                <td>                 
                <a title="@doc.TextId"  class="EditTask" href="#">@AcceptPortal.Resources.Global.PostEditTaskEditLabel  <div class="userContainer" style="display:none" title="@User.Identity.Name.ToString()"></div> </a>                                      
                |
                <a href="@documentReportUrl" target="_blank">@AcceptPortal.Resources.Global.PostEditCheckRevisionLabel</a> 
                |
                <a href="@allTasksReportUrl" target="_blank">@AcceptPortal.Resources.Global.AllTaskRevisionsLabel</a>            
                |
                    <a name="deleteTaskAnchor_&@doc.ID" href="@Url.Action("DeleteDocument", "PostEdit", new { @textId = doc.TextId, @projectOwner = Model.ProjectOwner, @projectId = doc.ProjectId })" target="_blank"></a> 
                
                <b style="cursor:pointer;" id="deleteTask_&@doc.ID" style="color:#0E9E4C;cursor:pointer">@AcceptPortal.Resources.Global.PostEditDeleteTaskLabel</b>
                </td>
                
            }
            else
            { 
            <td>                 
                <a title="@doc.TextId"  class="EditTask" href="#">@AcceptPortal.Resources.Global.PostEditTaskEditLabel   <div class="userContainer" style="display:none" title="@User.Identity.Name.ToString()"></div> </a>                                                  
            </td>                
            }                                                                                                                                                                                                                                                                                                                                                                                                  
        </tr>
       }
            </tbody>
    </table>  
    </div>
     <!--tasks section-->
    
}
else
{
    if (Model.Status == -1)
    {                 
        <h2>@AcceptPortal.Resources.Global.ProjectNotFoundMessage</h2>
    }
    else
        if ((Model.ProjectOwner.CompareTo(User.Identity.Name) != 0 && Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") != 0) && Model.Completed == 1)
        {
            
                 
           <h2>@AcceptPortal.Resources.Global.PostEditAllProjectsCompletedText</h2>        
            if (Model.ProjectSurvey.Length > 0)
            {
                string url = Model.ProjectSurvey.Trim();
                if (!url.StartsWith("http"))
                {
                    url = "http://" + url;
                }            
                
              <h4><p>@AcceptPortal.Resources.Global.PostEditGoFillSurveyText<a style="padding:5px;" href="@url" target="_blank">@Model.ProjectSurvey</a>  </p> </h4>                                   
            }
        }
        else
        {
           <h3>@AcceptPortal.Resources.Global.PosEditNoTasksCreatedLabel</h3>
            if (Model.ProjectOwner.CompareTo(User.Identity.Name) == 0 || Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") == 0)
            {
                <p>@AcceptPortal.Resources.Global.PosEditClickToCreateTaskText</p>       
            }
        }
}


<div id="divDialogManageProject" style="display:none" title="@Model.ProjectName">

    <div style="display:block;margin-top:15px;">
    @{Html.RenderAction("AllUsers", "Admin", new RouteValueDictionary { });}
        </div>
   
    <div id="divManageProjectLoader" style="display:none;height:100%;width:100%;text-align:center;margin-top:25px;vertical-align:middle;">
        <img src="@Url.Content("~/Content/images/ajax-loader.gif")" />
    </div>
    
    <div id="divUsersInProjectPlaceholder" style="display:block;margin-top:25px;">
    @*
    @{Html.RenderAction("AllProjectUsers", "PostEdit", new { token = Model.AdminToken });}
    *@
   </div>


</div>


<div id="inviteUsersDialog" style="display:none" title="@AcceptPortal.Resources.Global.PostEditInviteUsersDialogTitle  @Model.ProjectName">

<p>@AcceptPortal.Resources.Global.PostEditInsertEmailText</p>


@using (Ajax.BeginForm("InviteUsers", "PostEdit", new AjaxOptions { OnSuccess = "success", HttpMethod = "Post" }, new { id = "InviteForm" }))
{
    <input id="usersList" name="usersList" style="width:300px;height:25px" />
    
    if (Model.UserRoleInProject.CompareTo("PostEditProjMaintainer") == 0)
    {
    <input id="projectOwner" value="@User.Identity.Name" name="projectOwner" style="display:none;" /> 
    }
    else
    { 
    <input id="projectOwner" value="@Model.ProjectOwner" name="projectOwner" style="display:none;" /> 
    }
    
    <input id="projectInvitatedId" value="@Model.ID" name="projectInvitatedId" style="display:none;" />     
    <input type="submit" value="Log On" style="display:none;" />          
}

<p style="font-size:small;color:Red">@AcceptPortal.Resources.Global.PostEditInsertEmailsNoteText</p>

</div>


<div id="modalInviteConfirmation" title="@AcceptPortal.Resources.Global.PostEditInviteSentDialogTitle" style="display:none">
	<p>@AcceptPortal.Resources.Global.PostEditInviteSentParagraphOne @Model.ProjectName. </p> <p>@AcceptPortal.Resources.Global.PostEditEmailAccountText</p>
    <p>@AcceptPortal.Resources.Global.PostEditEmailAccountThankYouLabel</p>
    <p>@AcceptPortal.Resources.Global.PostEditAcceptPortalTeamLabel</p>
   
</div>
<div id="modalInviteConfirmationNotSent" title="@AcceptPortal.Resources.Global.PostEditInviteNotSentDialogTitle" style="display:none">
	<p>@AcceptPortal.Resources.Global.PostEditInvitationsFailedToSend</p>
    <p>@AcceptPortal.Resources.Global.PostEditEmailAccountThankYouLabel</p>
    <p>@AcceptPortal.Resources.Global.PostEditAcceptPortalTeamLabel</p>
   
</div>



<div id="modalDeleteTask" title="@AcceptPortal.Resources.Global.PostEditDeleteTaskDialogTitle" style="display:none;"><p>@AcceptPortal.Resources.Global.PostEditDeleteTaskDialogText</p></div>
<div id="dialogTaskStatus" title="@AcceptPortal.Resources.Global.ProjectTaskStatusDialogTitle" style="display:none;"></div>
<div title="@AcceptPortal.Resources.Global.MyProjectDetailsLabel" id="dialogMyProject" style="display:none;">
 <div style="padding:5px;margin:5px;">

     <p>
        @AcceptPortal.Resources.Global.ProjectAdminTokenMessage
    </p>

    <span>@AcceptPortal.Resources.Global.ProjectAdminToken</span>  <h3>@Model.AdminToken</h3> 
    </div>

</div>



@section scripts{

<script  type="text/javascript" src="@Url.Content("~/Scripts/PreEdit/v2.0/accept-jquery-plugin-2.0.js")" > </script>
<script type="text/javascript">

    var apiUrl = @Html.Raw(Json.Encode(ViewBag.AcceptApiUrl)); 
      
    function loadUsersTable()
    {
        $("#divUsersInProjectPlaceholder").css("display", "none");
        $("#divUsersInProjectPlaceholder").empty();
        $("#divManageProjectLoader").css("display","block");
        
        $("#divUsersInProjectPlaceholder").load('@Url.Action("AllProjectUsers", "PostEdit", new { token = Model.AdminToken })',function(){
        
            $("#txtAddUserToProject").val("");
            $("#divManageProjectLoader").css("display","none");
            $("#divUsersInProjectPlaceholder").css("display", "block");     
            createDataTable("#tblUsersInProject");                          
        
        });    
    }



    $(document).ready(function () {
      


        $('#tblPostEditTasks').contents().find(".EditTask").AcceptPostEdit({
            textIdContainer: 'title',
            dialogHeight: 630,
            dialogWidth: 850,
            acceptServerPath: apiUrl,                                                        
            userIdSelector: 'div.userContainer',
            userIdContainer: 'title',
            imagesPath: '../../../Content/PostEdit/v1.0/images',
            //preEditImagesPath: '../../../Content/PreEdit/v2.0/images',
            //preEditStyleSheetPath:'../../../Content/PreEdit/v2.0'
            preEditImagesPath: 'http://www.accept-portal.eu/Plugin/v2.0/css/images',
            preEditStyleSheetPath:'http://www.accept-portal.eu/Plugin/v2.0/css',             
            preEditServerPath: apiUrl,
            addPreEditPlugin:true

        });

        createDataTable("#tblPostEditTasks");

        //loadUsersTable();
        //var oTable = $('#tblPostEditTasks').dataTable({
        //"sDom": 'T<"clear">lfrtip',
        //"bStateSave": true,
        //});
       
       

        //dialog upload pos edit document.
        $("#btnOpenUploadDialog").click(function()
        {
            $("#divUploadFileDialog").dialog({ width: 'auto', height: 'auto', resizable: true, modal: false, title:@Html.Raw(Json.Encode(@AcceptPortal.Resources.Global.PostEditUploadProjectTask))});        
        });

        //add user to project event bind.
        $("#btnAddUserToProject").click(function(){  
                    
            $.ajax({
                type:"POST",
                url: @Html.Raw(Json.Encode(CoreUtils.AcceptPortalApiPath)) + '/Admin/UserProject',
                contentType:"application/json",
                dataType: 'json',
                async:true,
                cache:false,
                data:'{"UserName":"'+ $("#txtAddUserToProject").val() +'", "token":"'+@Html.Raw(Json.Encode(Model.AdminToken))+'" }',
                success: function()
                {
                    alert("User: " + $("#txtAddUserToProject").val() + " successfully added to project.");                    
                    /*$('#tblUsersInProject').dataTable().fnAddData( [ $('#txtAddUserToProject').val(), '<input type="checkbox" class="check-project-users" value="'+$('#txtAddUserToProject').val()+'">'] );
                    $("#txtAddUserToProject").val("");
                    $("#divManageProjectLoader").css("display","none");
                    $("#divUsersInProjectPlaceholder").css("display", "block");  */   
                    loadUsersTable();
                },
                error: function()
                {
                    alert("User: " + $("#txtAddUserToProject").val() + " not added to project.");
                    /*$("#txtAddUserToProject").val("");
                    $("#divManageProjectLoader").css("display","none");
                    $("#divUsersInProjectPlaceholder").css("display", "block");*/
                    loadUsersTable();
                }              
            });                
        });

        //dialog manage pos edit project.
        $("#btnDialogManageProject").click(function()
        {
            $("#divDialogManageProject").dialog({ width: 600, height: 400, resizable: true, modal: false, title:@Html.Raw(Json.Encode(AcceptPortal.Resources.Global.PosEditProjectDetail_LabelManageProject)),
                open:function()
                {
                    //createDataTable("#tblUsersInProject");                          
                    loadUsersTable();
                },buttons: 
                {
                    @Html.Raw(Json.Encode(@AcceptPortal.Resources.Global.PosEditProjectDetail_LabelClose)): function(){ $("#divDialogManageProject").dialog("destroy"); destroyTable("#tblUsersInProject"); },
                    @Html.Raw(Json.Encode(@AcceptPortal.Resources.Global.PosEditProjectDetail_LabelRemoveSelected)): function()
                    {                                          
                        $("#divUsersInProjectPlaceholder").css("display", "none");  
                        $("#divManageProjectLoader").css("display","block");                                          
                        $("#tblUsersInProject input:checked").each(function()
                        {
                            //alert($(this).val());
                            //var $closestTr = $(this).closest('tr');
                            var name = $(this).val();
                            $.ajax({
                            context: this,      
                            type:"DELETE",
                            url: @Html.Raw(Json.Encode(CoreUtils.AcceptPortalApiPath)) + '/Admin/UserProject',
                            contentType:"application/json",
                            dataType: 'json',
                            async:true,
                            cache:false,
                            data:'{"UserName":"'+ name +'", "token":"'+@Html.Raw(Json.Encode(Model.AdminToken))+'" }',
                            success: function()
                            {
                               //$closestTr.remove();
                            },
                            error: function(){}              
                        });                
                        
                        });//end each
                        //createDataTable("#tblUsersInProject");    
                        //$("#divManageProjectLoader").css("display","none");
                        //$("#divUsersInProjectPlaceholder").css("display", "block");
                        loadUsersTable();
                    },
                }            
            });        
        });

        
        $("#inviteUsersAnchor").click(function () {

            $("#inviteUsersDialog").dialog("destroy");

            var inviteButtonText = @Html.Raw(Json.Encode(AcceptPortal.Resources.Global.PostEditInviteButtonsDialogButton)); 

             $('#inviteUsersDialog').dialog({ width: 400, height: 300, resizable: true, modal: true,
                 open: function (event, ui) { },
                 close: function (event, ui) { },
                 drag: function (event, ui) { },
                 buttons: [
                 {
                     id: "btn-invite",
                     text: inviteButtonText,
                     click: function () {
                         debugger;
                         var submitForm = true;
                         var splittedEmailsAddresses = [];
                          
                         splittedEmailsAddresses = $('#usersList').val().split(';');
                          
                         if(splittedEmailsAddresses == null || splittedEmailsAddresses.length == 0)
                         {
                             submitForm = false;
                         }
                         else
                         {
                             for(var i = 0; i < splittedEmailsAddresses.length;i++)
                             {
                                 if(!validateEmail(splittedEmailsAddresses[i]))
                                     submitForm = false;
                             }
                            
                         } 
                                                    
                         if(submitForm)
                         {
                             $("#InviteForm").submit();
                             $('#inviteUsersDialog').dialog("close");
                         }
                         else
                             alert(@Html.Raw(Json.Encode(AcceptPortal.Resources.Global.InvalidEmailAddressMessage)));
                     
                     }
                 }
                 ]
             });
         });


      

        function inviteUsers(usersList) {
             debugger;
             var url = "PostEdit/InviteUsers";
             $.post(url, { "usersList": usersList },
              function (data) {
                  if (data) {
                      // alert("here");
                      // callback to show image/flag
                  } else {
                      //alert("there");
                      // callback to show error/permission
                  }
              });
        }


         $(function () {
             $('#InviteForm').submit(function () {
                 $.ajax({
                     url: this.action,
                     type: this.method,
                     data: $(this).serialize(),
                     success: function (result) {
                         // TODO: handle the results of the AJAX call
                         debugger;
                         var objResult = result;

                         if (objResult.ResponseStatus == "FAILED") {

                             $("#  modalInviteConfirmationNotSent").dialog("destroy");
                             $("#  modalInviteConfirmationNotSent").dialog({
                                 //height: 350,
                                 //width: 400,
                                 width:'auto',
                                 height:'auto',
                                 modal: true,
                                 buttons: {
                                     Ok: function() {
                                         $( this ).dialog( "close" );
                                     }
                                 }


                             });


                         }else 
                         {
                             $("#modalInviteConfirmation").dialog("destroy");
                             $("#modalInviteConfirmation").dialog({
                                 //height: 350,
                                 //width: 400,
                                 width:'auto',
                                 height:'auto',
                                 modal: true,
                                 buttons:
                                 {
                                     Ok: function() {
                                         $( this ).dialog( "close" );
                                     }
                                 }
                             });
                         }

                         $("#inviteUsersDialog").dialog("destroy");

                     }
                 });
                 return false;
             });
         });
      
        debugger;
        //check if the request come in from an invitation                  
        var uploadFailedMessageDetail = @Html.Raw(Json.Encode(ViewBag.MessageTaskUploadFail));     
        if(uploadFailedMessageDetail != null && uploadFailedMessageDetail.length >0)
        {                              
        alert(uploadFailedMessageDetail.toString());
        }          
        //delete task code
        $('b[id^="deleteTask_"]').click(function(){            
            debugger;
            var splittedId = $(this).attr("id").split('&');
            $("#modalDeleteTask" ).dialog( "destroy" );	            
            var yesLabel = @Html.Raw(Json.Encode(AcceptPortal.Resources.Global.LabelYes));
            var noLabel = @Html.Raw(Json.Encode(AcceptPortal.Resources.Global.LabelNo));
            $("#modalDeleteTask" ).dialog({
                width:'auto',
                height:'auto',
                //height: 200,
                //width: 300,
                modal: true,
                buttons:[{
                    id: "btn-yes",
                    text: yesLabel,
                    click: function () {                                       				                   
                        var url = $('a[name="deleteTaskAnchor_&' + splittedId[1] + '"]').attr("href");                    
                        //window.location.href='@Url.Action("Index", "Home")';
                        $(this).dialog( "close" );                                              
                        window.location.href= url;                       
                    }
            },
                {                 
                    id: "btn-no",
                    text: noLabel,
                    click: function () {
                        $(this).dialog( "close" );
                       
                    }                                  
                }]
		    });            
        });

        $("#checkTaskStatus").click(function(){
            $('#dialogTaskStatus').dialog({
                autoOpen: false,
                width:'auto',
                height:'auto',
                resizable: true,           
                modal: true,
                open: function(event, ui) {
                    //Load the CreateAlbumPartial action which will return 
                    // the partial view _CreateAlbumPartial
                    $(this).load("@Url.Action("GetTaskStatus", new { @token = Model.AdminToken })");
        },
        buttons: {
            "OK": function () {
                $(this).dialog("close");
            }
        }
        });
            $('#dialogTaskStatus').dialog('open');         
        });
            
        $("#myProjectDetails").click(function(e){            
            e.preventDefault();
            if($("#dialogMyProject").length > 0)
                $("#dialogMyProject").dialog("destroy");
            $("#dialogMyProject").dialog();            
        });
          

        


    });//end document ready
    </script>
    }


 









